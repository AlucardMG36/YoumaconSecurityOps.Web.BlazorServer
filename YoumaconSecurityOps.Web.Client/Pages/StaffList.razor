@page "/staff"

<Jumbotron Background="Background.Dark" Margin="Margin.Is2.FromTop.OnDesktop.Is1.FromTop.OnMobile" Border="Border.Dark.OnAll.Is1.Rounded" Shadow="Shadow.Default">
    <JumbotronTitle Casing="CharacterCasing.Title" Size="JumbotronTitleSize.Is4">View our Staff</JumbotronTitle>
    <Divider Background="Background.Light"></Divider>
    <Paragraph>
        <Heading Size="HeadingSize.Is6" TextColor="TextColor.Danger">Staff Members in Red are on a break</Heading>
    </Paragraph>
</Jumbotron>
<Divider />
<DataGrid @ref="@_dataGrid"
          TItem="StaffReader"
          ReadData="@OnReadData"
          Data="@_gridDisplay"
          TotalItems="@_totalStaffMembers"
          Editable="true"
          CommandMode="DataGridCommandMode.Commands"
          Responsive="true"
          Sortable="true"
          Hoverable="true"
          Striped="true"
          EditMode="DataGridEditMode.Popup"
          FixedHeader="true"
          FixedHeaderDataGridHeight="400px"
          @bind-SelectedRow="@_selectedStaffMember"
          RowStyling="@OnRowStyling"
          RowInserted="@OnRowInserted"
          NewItemDefaultSetter="@OnStaffNewItemDefaultSetter"
          Virtualize="true"
          DetailRowTrigger="@(item => item.Id == _selectedStaffMember?.Id)">
    <PopupTitleTemplate>
        @SetPopupTitle(context)
    </PopupTitleTemplate>
    <LoadingTemplate>
        <Span>
            <SpinKit Type="SpinKitType.Grid" Color="#ab3ed8" />
        </Span>
    </LoadingTemplate>
    <EmptyTemplate>
        <Span>
            <Paragraph>
                <Heading Size="HeadingSize.Is5" TextColor="TextColor.Danger">No Staff members found!</Heading>
            </Paragraph>
        </Span>
    </EmptyTemplate>
    <DataGridColumns>
        <DataGridCommandColumn TItem="StaffReader">
            <NewCommandTemplate>
                <Blazorise.Bootstrap5.Button Color="Color.Success"
                                            Border="Border.Dark.OnAll.Is1.Rounded"
                                            Shadow="Shadow.Default"
                                            Clicked="@context.Clicked">@context.LocalizationString</Blazorise.Bootstrap5.Button>
                                        </NewCommandTemplate>
                                        <SaveCommandTemplate>
                                            <Blazorise.Bootstrap5.Button Color="Color.Primary" Border="Border.Dark.OnAll.Is1.Rounded" Shadow="Shadow.Default" Clicked="@context.Clicked">@context.LocalizationString</Blazorise.Bootstrap5.Button>
                                        </SaveCommandTemplate>
                                        <CancelCommandTemplate>
                                            <Blazorise.Bootstrap5.Button Color="Color.Secondary" Border="Border.Dark.OnAll.Is1.Rounded" Shadow="Shadow.Default" Clicked="@context.Clicked">@context.LocalizationString</Blazorise.Bootstrap5.Button>
                                        </CancelCommandTemplate>
                                        <EditCommandTemplate>
                                            <Blazorise.Bootstrap5.Button Color="Color.Primary" Margin="Margin.Is2.OnX.OnDesktop.Is1.OnX.OnMobile" Padding="Padding.Is1.OnAll" Border="Border.Dark.OnAll.Is1.Rounded" Shadow="Shadow.Default" Clicked="@context.Clicked">@context.LocalizationString</Blazorise.Bootstrap5.Button>
                                        </EditCommandTemplate>
                                        <DeleteCommandTemplate>
                                            <Blazorise.Bootstrap5.Button Color="Color.None" Display="Display.None"></Blazorise.Bootstrap5.Button>
                                        </DeleteCommandTemplate>
                                    </DataGridCommandColumn>
                                    <DataGridColumn TItem="StaffReader" Field="Contact.PreferredName" Caption="Preferred Name" Sortable="false" Editable="true">
                                        <DisplayTemplate>
                                            @(context.Contact?.PreferredName)
                                        </DisplayTemplate>
                                        <EditTemplate>
                                            <TextEdit Text="@(context.Item.Contact?.PreferredName)" TextChanged="s => context.CellValue = s"></TextEdit>
                                        </EditTemplate>
                                    </DataGridColumn>
                                    <DataGridColumn TItem="StaffReader" Field="Contact.LastName" Caption="Last Name" Sortable="true" Editable="true">
                                        <DisplayTemplate>
                                            @(context.Contact?.LastName)
                                        </DisplayTemplate>
                                        <EditTemplate>
                                            <TextEdit Text="@(context.Item.Contact?.LastName)"></TextEdit>
                                        </EditTemplate>
                                    </DataGridColumn>
                                    <DataGridColumn TItem="StaffReader" Field="StaffType.Title" Caption="Type" Sortable="true" Editable="true">
                                        <DisplayTemplate>
                                            @(_staffTypes.SingleOrDefault(st => st.Id == context.StaffType?.Id)?.Title ?? String.Empty)
                                        </DisplayTemplate>
                                        <EditTemplate>
                                            <SelectList TItem="@StaffType"
                                                        TValue="Int32"
                                                        Data="@_staffTypes"
                                                        TextField="@((item) => item.Title)"
                                                        ValueField="@((item) => item.Id)"
                                                        SelectedValue="@_selectedStaffType"
                                                        SelectedValueChanged="@OnSelectedStaffTypeChanged"
                                                        DefaultItemText="@_staffTypes.Single(st => st.Id == 1).Title" />
                                        </EditTemplate>
                                    </DataGridColumn>
                                    <DataGridColumn TItem="StaffReader" Field="Role.Name" Caption="Role" Sortable="true" Editable="true">
                                        <DisplayTemplate>
                                            @(_staffRoles.SingleOrDefault(sr => sr.Id == context.Role?.Id)?.Name ?? String.Empty)
                                        </DisplayTemplate>
                                        <EditTemplate>
                                            <SelectList TItem="@StaffRole"
                                                        TValue="Int32"
                                                        Data="@_staffRoles"
                                                        TextField="@(item => item.Name)"
                                                        ValueField="@(item => item.Id)"
                                                        SelectedValue="@_selectedStaffRole"
                                                        SelectedValueChanged="@OnSelectedStaffRoleChanged"
                                                        DefaultItemText="@_staffRoles.Single(sr => sr.Id == 5).Name" />
                                        </EditTemplate>
                                    </DataGridColumn>
                                    <DataGridColumn TItem="StaffReader" Field="Contact.Email" Caption="Email" Sortable="false" Editable="true">
                                        <DisplayTemplate>
                                            <Blazorise.Link To="@($"mailto:{context.Contact?.Email}")"> @context.Contact?.Email</Blazorise.Link>
                                        </DisplayTemplate>
                                        <EditTemplate>
                                            <TextEdit Text="@(context.Item.Contact?.Email)" TextChanged="s => context.CellValue = s"></TextEdit>
                                        </EditTemplate>
                                    </DataGridColumn>
                                    <DataGridColumn TItem="StaffReader" Field="@nameof(StaffReader.IsBlackShirt)" Caption="Black Shirt?" ShowCaption="false" Displayable="false" Editable="true">
                                        <EditTemplate>
                                            <Blazorise.Bootstrap5.Switch TValue="bool" Checked="context.Item.IsBlackShirt" />
                                        </EditTemplate>
                                    </DataGridColumn>
                                    <DataGridColumn TItem="StaffReader" Field="@nameof(StaffReader.NeedsCrashSpace)" Caption="Needs Crash Space?" ShowCaption="false" Displayable="false" Editable="true">
                                        <EditTemplate>
                                            <Blazorise.Bootstrap5.Switch TValue="bool" Checked="context.Item.NeedsCrashSpace.GetValueOrDefault(false)" />
                                        </EditTemplate>
                                    </DataGridColumn>
                                    <DataGridColumn TItem="StaffReader" Field="@nameof(StaffReader.IsRaveApproved)" Caption="Rave Approved?" ShowCaption="false" Displayable="false" Editable="true">
                                        <EditTemplate>
                                            <Blazorise.Bootstrap5.Switch TValue="bool" Checked="context.Item.IsRaveApproved" />
                                        </EditTemplate>
                                    </DataGridColumn>
                                    <DataGridColumn TItem="StaffReader" Field="Contact.PhoneNumber" Caption="Phone Number" Sortable="false" Editable="true">
                                        <DisplayTemplate>
                                            <Blazorise.Link To="@($"tel:+{context.Contact?.PhoneNumber}")">@($"{context.Contact?.PhoneNumber:(###) ###-####}")</Blazorise.Link>
                                        </DisplayTemplate>
                                        <EditTemplate>
                                            <Blazorise.Bootstrap5.NumericEdit TValue="long" Value="@(Convert.ToInt64(context.CellValue))" ValueChanged="@( v => context.CellValue = v)"></Blazorise.Bootstrap5.NumericEdit>
                                        </EditTemplate>
                                    </DataGridColumn>
                                    <DataGridColumn TItem="StaffReader" Field="@nameof(StaffReader.ShirtSize)" Caption="Shirt Size" Sortable="false" Editable="true" />
                                </DataGridColumns>
                                <DetailRowTemplate>
                                    @{
                                        <DataGrid TItem="StaffReader"
                                                  Data="new List<StaffReader>{context}"
                                                  Sortable="false"
                                                  ShowCaptions="true">
                                            <DataGridCommandColumn TItem="StaffReader" />
                                            <DataGridColumn TItem="StaffReader" Field="@nameof(StaffReader.Id)" Caption="Actions">
                                                <DisplayTemplate Context="staffDetailContext">
                                                    <Buttons Role="ButtonsRole.Toolbar">
                                                        <Buttons Margin="Margin.Is2.FromRight">
                                                            <Blazorise.Bootstrap5.Button Color="Color.Primary" Clicked="@(async () => await SendMemberOnBreak(staffDetailContext.Id))" Loading="@_isLoading">
                                                                <LoadingTemplate><SpinKit Type="SpinKitType.CircleFade" Color="#fff"></SpinKit></LoadingTemplate>
                                                                <ChildContent>Send On Break</ChildContent>
                                                            </Blazorise.Bootstrap5.Button>
                                                            <Blazorise.Bootstrap5.Button Color="Color.Danger" Clicked="@(async () => await OnReturnedFromBreak(staffDetailContext.Id))" Loading="@_isLoading">
                                                                <LoadingTemplate><SpinKit Type="SpinKitType.CircleFade" Color="#fff"></SpinKit></LoadingTemplate>
                                                                <ChildContent>Return From Break</ChildContent>
                                                            </Blazorise.Bootstrap5.Button>
                                                        </Buttons>
                                                    </Buttons>
                                                </DisplayTemplate>
                                            </DataGridColumn>
                                            <DataGridColumn TItem="StaffReader" Field="@nameof(StaffReader.Id)" Caption="Actions" Sortable="false" Editable="false">
                                                <DisplayTemplate Context="detailInfoContext">
                                                    <Blazorise.Bootstrap5.Button Type="ButtonType.Button" Color="Color.Success" Clicked="@(async () => await SendMemberOnBreak(detailInfoContext.Id))">Send On Break</Blazorise.Bootstrap5.Button>
                                                </DisplayTemplate>
                                            </DataGridColumn>
                                            <DataGridCheckColumn TItem="StaffReader" Field="@nameof(StaffReader.IsOnBreak)" Caption="On Break?" Editable="true">
                                                <DisplayTemplate Context="staffDetailContext">
                                                    <Blazorise.Bootstrap5.Check TValue="bool" Checked="staffDetailContext.IsOnBreak" Disabled="true" ReadOnly="true" />
                                                </DisplayTemplate>
                                                <EditTemplate Context="staffEditContext">
                                                    <Blazorise.Bootstrap5.Check TValue="bool" Checked="staffEditContext.Item.IsOnBreak" Disabled="true" ReadOnly="true" />
                                                </EditTemplate>
                                            </DataGridCheckColumn>
                                            <DataGridCheckColumn TItem="StaffReader" Field="@nameof(StaffReader.IsBlackShirt)" Caption="Black Shirt?" Editable="true">
                                                <DisplayTemplate Context="staffDetailContext">
                                                    <Blazorise.Bootstrap5.Check TValue="bool" Checked="staffDetailContext.IsBlackShirt" Disabled="true" ReadOnly="true" />
                                                </DisplayTemplate>
                                                <EditTemplate Context="staffEditContext">
                                                    <Blazorise.Bootstrap5.Check TValue="bool" Checked="staffEditContext.Item.IsBlackShirt" Disabled="true" ReadOnly="true" />
                                                </EditTemplate>
                                            </DataGridCheckColumn>
                                            <DataGridCheckColumn TItem="StaffReader" Field="@nameof(StaffReader.IsRaveApproved)" Caption="Approved for Rave?" Editable="true">
                                                <DisplayTemplate Context="staffDetailContext">
                                                    <Blazorise.Bootstrap5.Check TValue="bool" Checked="staffDetailContext.IsRaveApproved" Disabled="true" ReadOnly="true" />
                                                </DisplayTemplate>
                                                <EditTemplate Context="staffEditContext">
                                                    <Blazorise.Bootstrap5.Check TValue="bool" Checked="staffEditContext.Item.IsRaveApproved" Disabled="true" ReadOnly="true" />
                                                </EditTemplate>
                                            </DataGridCheckColumn>
                                            <DataGridCheckColumn TItem="StaffReader" Field="@nameof(StaffReader.NeedsCrashSpace)" Caption="Needs Crash Space?" Editable="true">
                                                <DisplayTemplate Context="staffDetailContext">
                                                    <Blazorise.Bootstrap5.Check TValue="bool" Checked="staffDetailContext.NeedsCrashSpace ?? false" Disabled="true" ReadOnly="true" />
                                                </DisplayTemplate>
                                                <EditTemplate Context="staffEditContext">
                                                    <Blazorise.Bootstrap5.Check TValue="bool" Checked="staffEditContext.Item.NeedsCrashSpace ?? false" Disabled="true" ReadOnly="true" />
                                                </EditTemplate>
                                            </DataGridCheckColumn>
                                        </DataGrid>
                                    }
                                </DetailRowTemplate>
                            </DataGrid>